# Feed Generation Cloud Function - Database Schema

## Overview

This Cloud Function generates personalized social media feeds using a multi-profile architecture. **IMPORTANT**: One authenticated user (owner) can create multiple profiles of different types.

## Database Collections & Schema

### Collection: `profiles`

**Purpose**: Store user profiles (one user can have multiple profiles)

| Attribute | Type | Required | Indexed | Description |
|-----------|------|----------|---------|-------------|
| `$id` | string | ✅ | ✅ PK | Profile ID (auto-generated by Appwrite) |
| `ownerId` | string | ✅ | ✅ | **Appwrite Auth user ID** - links to authenticated user |
| `name` | string | ✅ | ❌ | Display name |
| `type` | string | ✅ | ✅ | Profile type: `"profile"`, `"business"`, `"channel"`, `"thread"` |
| `bio` | string | ❌ | ❌ | Profile biography |
| `handle` | string | ✅ | ✅ UNIQUE | Unique handle (e.g., @username) |
| `location` | string | ❌ | ❌ | User location |
| `profileImageUrl` | string | ❌ | ❌ | **File ID** from Appwrite Storage |
| `bannerImageUrl` | string | ❌ | ❌ | **File ID** from Appwrite Storage |
| `interests` | array | ❌ | ❌ | Interest tags for personalization |

**Indexes**:
- `ownerId` (get all profiles for a user)
- `type` (filter by profile type)
- `handle` (unique constraint + lookup)

**How Profiles Are Created**:

1. **User Authentication**: User signs up/logs in via Appwrite Auth, receives `userId` (ownerId)
   
2. **Profile Creation Flow** (via `add_pop_up_menu.dart`):
   ```dart
   // Step 1: User triggers profile creation
   final user = await appwriteService.getUser(); // Get Auth user
   
   // Step 2: Upload images to Storage (if selected)
   String? profileImageId;
   if (_profileImage != null) {
     final file = await appwriteService.uploadFile(
       bytes: _profileImage!.readAsBytesSync(),
       filename: _profileImage!.path.split('/').last,
     );
     profileImageId = file.$id;
   }
   
   // Step 3: Create profile document
   await appwriteService.createProfile(
     name: _nameController.text,
     type: _selectedType,              // 'profile', 'business', etc.
     bio: _bioController.text,
     handle: _handleController.text,
     location: _locationController.text,
     profileImageUrl: profileImageId ?? '',
     bannerImageUrl: bannerImageId ?? '',
   );
   ```

3. **Account Type Limits** (enforced in `add_pop_up_menu.dart`):
   - **Profile**: Max 1 per user
   - **Business**: Max 5 per user
   - **Thread**: Max 5 per user
   - **Channel**: Max 5 per user

4. **Handle Validation**:
   - Must be unique across all profiles
   - Only lowercase letters and numbers
   - Checked via `isHandleAvailable()` before creation

### Collection: `posts`

**Purpose**: Store all user-generated posts

| Attribute | Type | Required | Indexed | Description |
|-----------|------|----------|---------|-------------|
| `$id` | string | ✅ | ✅ PK | Post ID (auto-generated) |
| `profile_id` | string | ✅ | ✅ | Creator's **profile ID** (not user ID!) |
| `titles` | string | ❌ | ❌ | Post title |
| `caption` | string | ✅ | ❌ | Post text/caption |
| `file_ids` | array | ❌ | ❌ | **Array of File IDs** from Storage (not URLs) |
| `tags` | array | ❌ | ✅ | Interest tags (e.g., ["tech", "food"]) |
| `timestamp` | datetime | ✅ | ✅ DESC | Post creation time (ISO 8601 string) |
| `likes` | integer | ✅ | ✅ DESC | Current like count |
| `comments` | integer | ✅ | ❌ | Current comment count |
| `shares` | integer | ✅ | ❌ | Current share count |
| `views` | integer | ✅ | ❌ | Total views |
| `reportCount` | integer | ✅ | ❌ | Number of reports |
| `isHidden` | boolean | ✅ | ✅ | Hidden by moderation |
| `status` | string | ✅ | ✅ | `"active"`, `"archived"`, `"deleted"` |
| `is_nsfw` | boolean | ✅ | ❌ | NSFW content flag |
| `allow_share` | boolean | ✅ | ❌ | Allow external sharing |

**Critical Indexes**:
- `profile_id + timestamp DESC` (for user feeds)
- `tags + timestamp DESC` (for interest-based discovery)
- `status + isHidden + timestamp DESC` (for active posts query)
- `likes DESC + timestamp DESC` (for trending)

**Media Handling**:
```javascript
// file_ids stored as array: ["file_id_1", "file_id_2"]
// Convert to URLs in application:
const mediaUrls = post.file_ids.map(fileId => 
  appwriteService.getFileViewUrl(fileId)
);
```

**Engagement Score Calculation** (dynamic, not stored):
```javascript
engagementScore = likes + comments + (shares * 2)
```

### Collection: `follows`

**Purpose**: Track follow relationships (supports profiles, channels, threads)

| Attribute | Type | Required | Indexed | Description |
|-----------|------|----------|---------|-------------|
| `$id` | string | ✅ | ✅ PK | Follow ID (auto-generated) |
| `follower_id` | string | ✅ | ✅ | **Profile ID** of follower |
| `target_id` | string | ✅ | ✅ | **ID** of entity being followed |
| `follower_type` | string | ✅ | ❌ | `"public"` or `"private"` (anonymous follow) |
| `target_type` | string | ✅ | ✅ | `"profile"`, `"channel"`, `"thread"` |
| `timestamp` | datetime | ✅ | ❌ | Follow timestamp |

**Indexes**:
- `follower_id + target_type + timestamp DESC`
- `target_id + target_type`
- Composite unique: `follower_id + target_id + target_type`

**Example Queries**:
```javascript
// Get profiles that current profile follows
Query.equal('follower_id', currentProfileId)
Query.equal('target_type', 'profile')

// Get follower count for a profile
Query.equal('target_id', profileId)
Query.equal('target_type', 'profile')
```

### Collection: `likes`

**Purpose**: Track which users liked which posts (owner-level, not profile-level)

| Attribute | Type | Required | Indexed | Description |
|-----------|------|----------|---------|-------------|
| `$id` | string | ✅ | ✅ PK | Like ID (auto-generated) |
| `userId` | string | ✅ | ✅ | **Appwrite Auth user ID** (ownerId) |
| `postId` | string | ✅ | ✅ | Post being liked |
| `timestamp` | datetime | ✅ | ❌ | When like occurred |

**Indexes**:
- Composite unique: `userId + postId` (prevent duplicate likes)
- `postId + timestamp DESC`

**Important**: Likes are at **owner level**, not profile level. One owner can only like a post once across all their profiles.

### Collection: `comments`

**Purpose**: Store post comments

| Attribute | Type | Required | Indexed | Description |
|-----------|------|----------|---------|-------------|
| `$id` | string | ✅ | ✅ PK | Comment ID (auto-generated) |
| `post_id` | string | ✅ | ✅ | Post being commented on |
| `profile_id` | string | ✅ | ✅ | **Profile ID** of commenter |
| `text` | string | ✅ | ❌ | Comment text |
| `timestamp` | datetime | ✅ | ✅ DESC | Comment creation time |
| `parent_comment_id` | string | ❌ | ✅ | For nested/reply comments |

**Indexes**:
- `post_id + timestamp DESC`
- `parent_comment_id`

### Collection: `owner_signals`

**Purpose**: Track user engagement patterns for ranking (aggregates across all profiles)

| Attribute | Type | Required | Indexed | Description |
|-----------|------|----------|---------|-------------|
| `$id` | string | ✅ | ✅ PK | Signal ID (auto-generated) |
| `ownerId` | string | ✅ | ✅ | **Appwrite Auth user ID** |
| `profileId` | string | ✅ | ❌ | Which profile was active when signal sent |
| `postId` | string | ✅ | ✅ | Post interacted with |
| `signalType` | string | ✅ | ✅ | `"like"`, `"comment"`, `"share"`, `"skip"`, `"dwell"` |
| `dwellTime` | integer | ❌ | ❌ | Milliseconds spent viewing (for dwell signals) |
| `timestamp` | datetime | ✅ | ✅ DESC | Signal timestamp |

**Indexes**:
- `ownerId + signalType + timestamp DESC`
- `postId + signalType`

**Why ownerId not profileId**: Signals aggregate at owner level for better personalization across all profiles.

### Collection: `seen_posts`

**Purpose**: Deduplicate feed at owner level

| Attribute | Type | Required | Indexed | Description |
|-----------|------|----------|---------|-------------|
| `$id` | string | ✅ | ✅ PK | Seen ID (auto-generated) |
| `ownerId` | string | ✅ | ✅ | **Appwrite Auth user ID** |
| `postId` | string | ✅ | ✅ | Post ID |
| `sessionId` | string | ✅ | ✅ | Current session identifier |
| `seenAt` | datetime | ✅ | ✅ DESC | When post was shown |

**Indexes**:
- Composite unique: `ownerId + sessionId + postId`
- `seenAt` (for TTL cleanup)

**TTL**: Auto-delete entries older than 24 hours

### Collection: `ads`

**Purpose**: Store sponsored ad content

| Attribute | Type | Required | Indexed | Description |
|-----------|------|----------|---------|-------------|
| `$id` | string | ✅ | ✅ PK | Ad ID (auto-generated) |
| `advertiserId` | string | ✅ | ✅ | Advertiser's user ID |
| `content` | string | ✅ | ❌ | Ad text/caption |
| `mediaUrl` | string | ✅ | ❌ | Ad creative URL |
| `targetTags` | array | ❌ | ✅ | Interest targeting |
| `bidCpm` | integer | ✅ | ✅ DESC | Bid in CPM (cost per 1000 impressions) |
| `budget` | integer | ✅ | ❌ | Remaining budget in cents |
| `clickProbability` | float | ✅ | ❌ | Estimated CTR (0.0 to 1.0) |
| `isActive` | boolean | ✅ | ✅ | Ad campaign status |

**Indexes**:
- `isActive + targetTags + bidCpm DESC`

## Multi-Profile Architecture

### Key Concepts

1. **Owner vs Profile**:
   - **Owner**: Authenticated user with Appwrite Auth (`userId`/`ownerId`)
   - **Profile**: Public-facing identity created by owner (can have multiple)

2. **One Owner → Many Profiles**:
   ```
   Owner (ownerId: "user_123")
     ├─ Profile A (type: "profile", handle: "@john")
     ├─ Profile B (type: "business", handle: "@johncorp")
     └─ Profile C (type: "channel", handle: "@johntech")
   ```

3. **Profile-Level Actions**:
   - Creating posts (`profile_id`)
   - Following others (`follower_id`)
   - Commenting (`profile_id`)

4. **Owner-Level Actions**:
   - Liking posts (`userId`)
   - Tracking signals (`ownerId`)
   - Feed deduplication (`ownerId`)

### Why This Matters for Feed Generation

- **Candidate Selection**: Aggregates follows from ALL owner's profiles
- **Personalization**: Uses signals across ALL profiles for better recommendations
- **Deduplication**: Prevents showing same post twice across sessions
- **Cold Start**: Checks total follows across all profiles, not per-profile

## Common Query Patterns

### Get All Profiles for a User
```javascript
databases.listDocuments('profiles', [
  Query.equal('ownerId', userId)
])
```

### Get Posts from Followed Profiles
```javascript
// Step 1: Get all user's profiles
const profiles = await databases.listDocuments('profiles', [
  Query.equal('ownerId', ownerId)
]);
const profileIds = profiles.documents.map(p => p.$id);

// Step 2: Get follows
const follows = await databases.listDocuments('follows', [
  Query.equal('follower_id', profileIds),
  Query.equal('target_type', 'profile')
]);
const followedProfileIds = follows.documents.map(f => f.target_id);

// Step 3: Get posts
const posts = await databases.listDocuments('posts', [
  Query.equal('profile_id', followedProfileIds),
  Query.equal('status', 'active'),
  Query.equal('isHidden', false),
  Query.orderDesc('timestamp')
]);
```

### Check if User Liked Post
```javascript
databases.listDocuments('likes', [
  Query.equal('userId', ownerId),
  Query.equal('postId', postId)
])
// If total > 0, user has liked
```

### Get Post's Media URLs
```javascript
const mediaUrls = post.file_ids.map(fileId => 
  `${APPWRITE_ENDPOINT}/storage/buckets/${BUCKET_ID}/files/${fileId}/view`
);
```

## Deployment Checklist

Before deploying this Cloud Function:

1. ✅ Ensure all collections exist with correct attributes
2. ✅ Create all required indexes (see each collection section)
3. ✅ Set up unique constraints (handle, userId+postId, etc.)
4. ✅ Configure TTL rules for `seen_posts` (24 hours)
5. ✅ Update environment variables (DATABASE_ID, etc.)
6. ✅ Deploy function with `main.js` as entry point

## Error Prevention

### Common Mistakes to Avoid

❌ **Using `userId` for posts** → Use `profile_id`  
❌ **Using `createdAt`** → Use `timestamp`  
❌ **Storing media URLs** → Store `file_ids`, generate URLs on read  
❌ **Pre-calculating engagement** → Calculate dynamically from likes/comments/shares  
❌ **Single profile per user** → Support multiple profiles per owner  
❌ **Profile-level likes** → Likes are at owner level (`userId` not `profileId`)

### Validation Before Queries

```javascript
// Always filter active posts
Query.equal('status', 'active')
Query.equal('isHidden', false)

// Always use correct field names
Query.orderDesc('timestamp')  // ✅ NOT 'createdAt'
Query.equal('profile_id', id) // ✅ NOT 'userId'
```

## Support & Documentation

For more details:
- **Implementation Plan**: See `implementation_plan.md` for full architecture
- **Schema Corrections**: See `schema_corrections.md` for migration from old schema
- **Walkthrough**: See `walkthrough.md` for deployment guide

---

**Last Updated**: 2025-12-30  
**Schema Version**: 1.0 (Multi-Profile)
